name: Publish Docker image

on:
  push:
    branches:
      - feature/deploy

jobs:
  build-test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      - name: Build and test challenge-front
        run: |
          cd challenge-front
          npm install
          npm run build
      - name: Build and test challenge-users
        run: |
          cd challenge-users
          npm install
          npm run build
      - name: Build and test challenge-gateway
        run: |
          cd challenge-gateway
          npm install
          npm run build
      - name: Build and test challenge-mailer
        run: |
          cd challenge-mailer
          npm install
          npm run build

  publish-docker:
    runs-on: ubuntu-latest

    needs: build-test

    steps:
      - uses: actions/checkout@v2

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Build and push challenge-front
        # if: ${{ github.event_name == 'push' && contains(github.event.head_commit.modified, 'challenge-front/') }}
        uses: docker/build-push-action@v2
        with:
          context: ./challenge-front
          file: ./challenge-front/Dockerfile
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/challenges2-yacine:latest
      
      - name: Build and push challenge-users
        # if: ${{ github.event_name == 'push' && contains(github.event.head_commit.modified, 'challenge-users/') }}
        uses: docker/build-push-action@v2
        with:
          context: ./challenge-users
          file: ./challenge-users/Dockerfile
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/challenges2-yacine-users:latest
      
      - name: Build and push challenge-gateway
        # if: ${{ github.event_name == 'push' && contains(github.event.head_commit.modified, 'challenge-gateway/') }}
        uses: docker/build-push-action@v2
        with:
          context: ./challenge-gateway
          file: ./challenge-gateway/Dockerfile
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/challenges2-yacine-gateway:latest
      
      - name: Build and push challenge-mailer
        # if: ${{ github.event_name == 'push' && contains(github.event.head_commit.modified, 'challenge-mailer/') }}
        uses: docker/build-push-action@v2
        with:
          context: ./challenge-mailer
          file: ./challenge-mailer/Dockerfile
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/challenges2-yacine-mailer:latest
      
  deploy-kubernetes:
    runs-on: ubuntu-latest
    needs: publish-docker
    steps:
      - name: Set up Kubernetes
        uses: google-github-actions/setup-gcloud@v0.3.0
        with:
          project_id: calcium-post-383607
          service_account_key: |
            {
              "type": "service_account",
              "project_id": "calcium-post-383607",
              "private_key_id": "b951b43b211ce4c0266e8cc2cb28b46939a1136b",
              "private_key": "-----BEGIN PRIVATE KEY-----\nMIIEvAIBADANBgkqhkiG9w0BAQEFAASCBKYwggSiAgEAAoIBAQCEm9GM7ojKNioN\nWKg3eX8PUoUyerQMbzw3LnvJ4yXGkdBJCsD/xPe6P/DT9gnObG3NEteijlktYGxQ\nT0AwOSxgNtDBI+LwIYuIyIwoWSlLh6dinkzAfKbUvY2wSBvAG+HuD89MEOuUfE2Y\nsfcyaG+X1x+NGpsOvEzZ6hmN81CSqJbYRPv7sVliX5E9SPHT49SogSR9KWaUJl2A\neUs1MaxM/pS8q38JSGknUjs/glEWdI6At/IYpsHqkf09sboIPUW1d4nyS5Pt9RJQ\ngG+8RtssLG4BlcNyiBUjyeCHrurB6Y2abfRWIPs6oxu3+1y6S+cC5ZnpmUFeUoyd\nrORWy5yBAgMBAAECggEAN9aU6k8W8m7UTkJistlKE12gEJ1yazn7lRDRtzUalv6X\nQepxUkHSPm7mLZqQjodBxPSGMEDYdC8B7N8yHBw2/1yVkn5V9N9rLfGkcuj4ZoF8\njh4yG2thpHscynnSlZYoEGI/27vUNvYQhpeJi4RGWR2Qf44QdKf9hFT65bbq2pXf\noLFuNBdcYawpwvnXJxXDKpnkNs7d7+Uh8uPZhpriJGr4z+PmGVOfqriWSfrILV1U\nBBbHStYYekk093WvV/N193cueBFgcBaTbJPgxchHpsI/hJFUXLNV26E80SQ2L8Ho\nZuKGq8SNFKKqqumXWcwWSrSJDRBcOk+hWtbcTT268QKBgQC6iaLGa6ig/WBIlry2\nMfx796vrQA8Mh0ZW+DStCR9+RMQAQVOGDxKSqThF71YV6R9ygeXClsFTXn4Y8vMH\naS5maGH6lk3AmoRyssSJLKltf7JXx7v/z1OPdw/5U3mg7iSubo7mn59/xemFAgTf\n5NYJuqZjxDSP4MxPmagqw9w4SwKBgQC1/TYglUnpoC1zLthIPXvwO05G7LNyluJP\nHPA7qvj6M0ytPhxcTQ3KVj8OQyNqtaYjStO2czBk29d9IPmibXUVcy6p0s8acjXs\nzmMz6c/X4eSi8jCC54WKLJrNsIGpFKsBv2GBuYTG4hTEQ2li8F45/HxUJpFSI1sp\nEQD8LgXW4wKBgDeqPPXjSKYKFoJy4QuprQO9bAM+0X7Wm2n2lZmRYGGI2ciNtgQK\nWWuErfNIsbLGJ4k/NDY2UKi1SQHe9iEfBSawPZTO55LzSVUE/dtFhaXUdn71bqeu\n0eu9BvpLK7+XcUDQYzp1Jd62S7JSYOwDWM/8cAzTjy/kUHPskZ95ZS0zAoGALJ3G\nXlibRUZ6vglXBubj8rJnb2XqXIZ3NxQOJWK2JYjcHIDkrRBK+DcKwHFfRnMAJxja\nLJmy3Jc1Dj0+Vj7lfHu/jezbz0z+wW6bzYdd6Dw+NGCR2hXunEBxN0o1j4E8p3IG\n8qnLzoJwuukX9iSdxTOMO4k1CWEXoUrE5g5WaicCgYBO1Du3jdYVH+UBC96HATXL\n4c17PG0zxy9EKuY4o4ySu0duGpWy1WNd+PCT1vDjE2ihf3kh9nz04f6Ovyj+jxiN\nmUmRz68/OQIVefV2h8e7UYrWUM42q+FyWvkV6iobhXM5b5994VlXUuguK3mNKKRE\nOgYG36VHMNr1jlkB3pDQ3A==\n-----END PRIVATE KEY-----\n",
          cluster_name: marketplace
          zone: europe-west1
 
      - name: Configure kubectl
        run: |
          gcloud container clusters get-credentials marketplace --zone europe-west1 --project calcium-post-383607

      - name: Deploy challenge-front
        run: |
          kubectl patch deployment challenge-front -p "{\"spec\":{\"template\":{\"metadata\":{\"labels\":{\"date\":\"`date +'%s'`\"}}}}}"
      - name: Deploy challenge-users
        run: |
          kubectl patch deployment challenge-users -p "{\"spec\":{\"template\":{\"metadata\":{\"labels\":{\"date\":\"`date +'%s'`\"}}}}}"
      
      - name: Deploy challenge-gateway
        run: |
          kubectl patch deployment challenge-gateway -p "{\"spec\":{\"template\":{\"metadata\":{\"labels\":{\"date\":\"`date +'%s'`\"}}}}}"
      
      - name: Deploy challenge-mailer
        run: |
          kubectl patch deployment challenge-mailer -p "{\"spec\":{\"template\":{\"metadata\":{\"labels\":{\"date\":\"`date +'%s'`\"}}}}}"

